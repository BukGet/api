/*
 jSmart Javascript template engine
 http://code.google.com/p/jsmart/

 Copyright 2011, Max Miroshnikov <miroshnikov at gmail dot com> 
 jSmart is licensed under the GNU General Public License
 http://www.apache.org/licenses/LICENSE-2.0
*/
(function(){function t(a,b){for(var c=2;c<arguments.length;++c)for(var d in arguments[c])if(typeof arguments[c][d]=="object"&&arguments[c][d]!=null){b[a+d]=arguments[c][d]instanceof Array?[]:{};t("",b[a+d],arguments[c][d])}else b[a+d]=arguments[c][d];return b}function D(a){var b=0,c;for(c in a)b++;return b}function w(a){return a.replace(/^\s+|\s+$/g,"").replace(/^['"]{1}|['"]{1}$/g,"")}function q(a,b){for(var c=0,d=0,e=jSmart.prototype.auto_literal,f=RegExp("^{ *("+a+") *}$","i"),g=0;g<b.length;++g)if(b.substr(g,
1)=="{"){if(!(e&&g+1<b.length&&" \n\r\t".indexOf(b[g+1])>=0)){if(!c){b=b.slice(g);d+=g;g=0}++c}}else if(b.substr(g,1)=="}")if(!(e&&g-1>=0&&" \n\r\t".indexOf(b[g-1])>=0)){if(!--c){var h=b.slice(0,g+1).replace(/[\r\n]/g," ").match(f);if(h){h.index=d;return h}}if(c<0)c=0}return null}function A(a,b,c){var d="",e=null,f=null,g=0;do{if(e)g+=e[0].length;e=q(a,c);if(!e)throw Error("Unclosed {"+b+"}");d+=c.slice(0,e.index);g+=e.index;c=c.slice(e.index+e[0].length);if(f=q(b,d))d=d.slice(f.index+f[0].length)}while(f);
e.index=g;return e}function x(a,b,c,d){for(var e=0,f=q(c,d);f;f=q(c,d)){var g=q(a,d);if(!g||g.index>f.index){f.index+=e;return f}else{d=d.slice(g.index+g[0].length);e+=g.index+g[0].length;f=A(b,a,d);d=d.slice(f.index+f[0].length);e+=f.index+f[0].length}}return null}function y(a){if(!a.match(/^ *['"].+["'] *$/))return a.replace(RegExp("\\$([\\w]+)@(index|iteration|first|last|show|total)","gi"),"$$$1__$2");return a}function o(a,b){if(typeof a=="string")with(E)with(b)try{return eval(a)}catch(c){throw Error(c.message+
" in \n"+a);}return a}function F(a){a=a.replace(/([^ ]+|\([^)]+\))is[ ]*div[ ]*by([^ ]+|\([^)]+\))/g,"!($1%$2)");a=a.replace(/([^ ]+|\([^)]+\))is[ ]*not[ ]*div[ ]*by([^ ]+|\([^)]+\))/g,"($1%$2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*even[ ]*/g,"!($1%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*not[ ]*even[ ]*/g,"($1%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*even[ ]*by[ ]*([^ ]+|\([^)]+\))/g,"!($1/$2)%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*not[ ]*even[ ]*by[ ]*([^ ]+|\([^)]+\))/g,"($1/$2)%2)");
a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*odd[ ]*/g,"($1%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*not[ ]*odd[ ]*/g,"!($1%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*odd[ ]*by[ ]*([^ ]+|\([^)]+\))/g,"($1/$2)%2)");a=a.replace(/([^ ]+|\([^)]+\))[ ]*is[ ]*not[ ]*odd[ ]*by[ ]*([^ ]+|\([^)]+\))/g,"!($1/$2)%2)");a=a.replace(/([) ])eq([ (])/g,"$1==$2");a=a.replace(/([) ])(ne|neq)([ (])/g,"$1!=$3");a=a.replace(/([) ])gt([ (])/g,"$1>$2");a=a.replace(/([) ])lt([ (])/g,"$1<$2");a=a.replace(/([) ])(ge|gte)([ (])/g,
"$1>=$2");a=a.replace(/([) ])(le|lte)([ (])/g,"$1<=$2");a=a.replace(/([) ])mod([ (])/g,"$1%$2");return a=a.replace(/([( ])not([( ])/g,"$1!$2")}function i(a,b){for(var c=q(".+",a);c;c=q(".+",a)){var d=a.slice(0,c.index);d.length&&b.push({type:"text",data:d});a=a.slice(c.index+c[0].length);var e=c[1].match(/^ *(\w+)(.*)$/);if(e){d=e[1];e=e.length>2?e[2]:"";if(d in r)if(r[d].type=="block"){a=a.replace(/^\n/,"");c=A("/"+d,d+" +[^}]*",a);r[d].parse(e,b,a.slice(0,c.index));a=a.slice(c.index+c[0].length)}else{r[d].parse(e,
b);if(d=="extends")b=[]}else if(d in p){c=p[d];if(c.type=="block"){c=A("/"+d,d+" +[^}]*",a);var f=a.slice(0,c.index),g=[];b.push({type:"plugin",name:d,params:l(e),subTree:g});i(f,g);a=a.slice(c.index+c[0].length)}else c.type=="function"&&b.push({type:"plugin",name:d,params:l(e)})}else b.push({type:"var",name:y(c[1])});a=a.replace(/^\n/,"")}else if(e=c[1].match(/^ *\$([\[\w'"\]]+) *= *(.*) *$/)){r.assign.parse(" var="+e[1]+" value="+e[2]+" shorthand=1",b);a=a.replace(/^\n/,"")}else b.push({type:"var",
name:y(c[1])})}a.length&&b.push({type:"text",data:a})}function l(a){var b={},c=/ +([\w]+) *=/,d=a;a=[];for(var e=d.match(c);e;e=d.match(c)){a.push(d.slice(0,e.index));e[1]&&a.push(e[1]);d=d.slice(e.index+e[0].length)}d.length&&a.push(d);for(c=1;c<a.length-1;c+=2)b[a[c]]=y(a[c+1]);return b}function n(a,b){var c={},d;for(d in a){var e=a[d];if(e&&e.match(/^ *"\$.*" *$/)&&B(eval(e),b))e=eval(e);c[d]=o(e,b)}c.__get=function(f,g){return f in c&&typeof c[f]!="undefined"?c[f]:g};return c}function B(a,b){if(!a.match(/^ *[$]/))return false;
try{with(b)eval(a)}catch(c){return false}return true}function k(a,b){for(var c="",d=0;d<a.length;++d){var e=a[d];if(e.type=="text")c+=e.data;else if(e.type=="var"){c=c;var f=e.name;e=b;var g=/(\$[^|]+|".+?"|'.+?')\|\w+/,h=/^\|(\w+)(:)?/,m="",j=null;for(j=f.match(g);j;j=f.match(g))if(j[1].substr(0,1)=="$"&&B(j[1],e)||j[1].substr(0,1)=="'"||j[1].substr(0,1)=='"'){m+=f.slice(0,j.index);f=f.slice(j.index+j[1].length);j=[j[1]];var s=null;for(s=f.match(h);s;s=f.match(h)){f=f.slice(s[1].length+1);if(s.length>
2){f=f;var H=j,G=/^:(".+?"|'.+?'|.*?)([\s:|,))]|$)/,u=null;for(u=f.match(G);u;u=f.match(G)){H.push(u[1]);f=f.slice(u[1].length+1);if(u[2]!=":")break}f=f}j=[(s[1]=="default"?"defaultValue":s[1])+"("+j.join(",")+")"]}m+=j[0]}else{m+=f.slice(0,j.index+j[0].length);f=f.slice(j.index+j[0].length)}m+=f;c=c+o(m,b)}else if(e.type=="build-in")c+=r[e.name].process(e,b);else if(e.type=="plugin"){g=p[e.name];if(g.type=="block"){g={value:true};for(p[e.name].process(n(e.params,b),"",b,g);g.value;){g.value=false;
c+=p[e.name].process(n(e.params,b),k(e.subTree,b),b,g)}}else if(g.type=="function")c+=p[e.name].process(n(e.params,b),b)}}return c}function C(a){for(var b="",c=a.match(/{\*/);c;c=a.match(/{\*/)){b+=a.slice(0,c.index);a=a.slice(c.index+c[0].length);c=a.match(/\*}/);if(!c)throw Error("Unclosed {*");a=a.slice(c.index+c[0].length)}return b+a}var r={section:{type:"block",parse:function(a,b,c){var d=[],e=[];b.push({type:"build-in",name:"section",params:l(a),subTree:d,subTreeElse:e});if(a=x("section [^}]+",
"/section","sectionelse",c)){i(c.slice(0,a.index),d);i(c.slice(a.index+a[0].length).replace(/^[\r\n]/,""),e)}else i(c,d)},process:function(a,b){var c=n(a.params,b),d={};b.$smarty.section[c.name]=d;var e=c.__get("show",true);d.show=e;if(!e)return k(a.subTreeElse,b);var f="";if(c.loop instanceof Object){if(this.foreach(c.name,c.__get("start",0),c.loop instanceof Array?c.loop.length:D(c.loop),c.__get("step",1),c.__get("max",Number.MAX_VALUE),b,d,function(g){eval(c.name+" = "+g+";");f+=k(a.subTree,b)}))return f}else if(parseInt(c.loop))if(this.foreach(c.name,
c.__get("start",0),parseInt(c.loop),c.__get("step",1),c.__get("max",Number.MAX_VALUE),b,d,function(){f+=k(a.subTree,b)}))return f;return k(a.subTreeElse,b)},foreach:function(a,b,c,d,e,f,g,h){if(b<0){b=c+b;if(b<0)b=0}else if(b>=c)b=c?c-1:0;a=0;for(f=b;f>=0&&f<c&&a<e;f+=d,++a);g.total=a;g.loop=a;a=0;for(f=b;f>=0&&f<c&&a<e;f+=d,++a){g.first=f==b;g.last=f+d<0||f+d>=c;g.index=f;g.index_prev=f-d;g.index_next=f+d;g.iteration=g.rownum=a+1;h(f)}return a}},"for":{type:"block",parse:function(a,b,c){var d=a.match(/^ *\$(\w+) *= *([^ ]+) *to *([^ ]+) *(step *([^ ]+))? *(.*)$/);
if(!d)throw Error("Invalid {for} parameters: "+a);a=l(" "+d[6]);a.varName="'"+d[1]+"'";a.from=d[2];a.to=d[3];a.step=d[5];d=[];var e=[];b.push({type:"build-in",name:"for",params:a,subTree:d,subTreeElse:e});if(b=x("for [^}]+","/for","forelse",c)){i(c.slice(0,b.index),d);i(c.slice(b.index+b[0].length),e)}else i(c,d)},process:function(a,b){var c=n(a.params,b),d=c.__get("step",1),e=c.__get("max",Number.MAX_VALUE),f=0,g="";e=Math.min(Math.ceil(((d>0?c.to-c.from:c.from-c.to)+1)/Math.abs(d)),e);for(var h=
c.from;f<e;h+=d,++f){b["$"+c.varName]=h;g+=k(a.subTree,b)}f||(g=k(a.subTreeElse,b));return g}},"if":{type:"block",parse:function(a,b,c){a=y(F(a));var d=[],e=[];b.push({type:"build-in",name:"if",params:a,subTreeIf:d,subTreeElse:e});if(a=x("if [^}]+","/if","else[^}]*",c)){i(c.slice(0,a.index),d);c=c.slice(a.index+a[0].length);(d=a[1].match(/^if(.*)/))?r["if"].parse(d[1],e,c.replace(/^[\r\n]/,"")):i(c.replace(/^[\r\n]/,""),e)}else i(c,d)},process:function(a,b){return o(a.params,b)?k(a.subTreeIf,b):k(a.subTreeElse,
b)}},foreach:{type:"block",parse:function(a,b,c){var d=null,e=null,f=null,g=null,h=a.match(/^ *\$(\w+) *as *\$(\w+) *(=> *\$(\w+))? *$/i);if(h){d="$"+h[1];e=h[4]?h[4]:h[2];f=h[4]?h[2]:null}else{a=l(a);d=a.from;e=w(a.item);if("key"in a)f=w(a.key);if("name"in a)g=w(a.name)}a=[];h=[];b.push({type:"build-in",name:"foreach",arr:d,keyName:f,varName:"$"+e,loopName:g,subTree:a,subTreeElse:h});if(b=x("foreach [^}]+","/foreach","foreachelse",c)){i(c.slice(0,b.index),a);i(c.slice(b.index+b[0].length).replace(/^[\r\n]/,
""),h)}else i(c,a)},process:function(a,b){var c=a.arr in b?b[a.arr]:w(a.arr);c instanceof Object||(c=[c]);var d=c instanceof Array?c.length:D(c);b[a.varName+"__total"]=d;if(a.loopName){b.$smarty.foreach[a.loopName]={};b.$smarty.foreach[a.loopName].total=d}var e="",f=0,g;for(g in c){if(c instanceof Array){g=parseInt(g);if(isNaN(g))continue}b[a.varName+"__key"]=g;if(a.keyName)b["$"+a.keyName]=b[a.varName+"__key"];b[a.varName]=c[g];b[a.varName+"__index"]=parseInt(f);b[a.varName+"__iteration"]=parseInt(f+
1);b[a.varName+"__first"]=f===0;b[a.varName+"__last"]=f==d-1;if(a.loopName){b.$smarty.foreach[a.loopName].index=parseInt(f);b.$smarty.foreach[a.loopName].iteration=parseInt(f+1);b.$smarty.foreach[a.loopName].first=f===0?1:"";b.$smarty.foreach[a.loopName].last=f==d-1?1:""}e+=k(a.subTree,b);++f}b[a.varName+"__show"]=f>0;if(a.loopName)b.$smarty.foreach[a.loopName].show=f>0?1:"";if(f>0)return e;return k(a.subTreeElse,b)}},"while":{type:"block",parse:function(a,b,c){a=F(a);var d=[];b.push({type:"build-in",
name:"while",params:a,subTree:d});i(c,d)},process:function(a,b){var c="";for(o(a.params,b);o(a.params,b);)c+=k(a.subTree,b);return c}},capture:{type:"block",parse:function(a,b,c){var d=[];b.push({type:"build-in",name:"capture",params:l(a),subTree:d});i(c,d)},process:function(a,b){var c=n(a.params,b),d=k(a.subTree,b);b.$smarty.capture[c.__get("name","default")]=d;var e=c.__get("assign",null);if(e)b["$"+e]=d;if(c=c.__get("append",null)){c="$"+c;if(c in b)b[c]instanceof Array&&b[c].push(d);else b[c]=
[d]}return""}},"function":{type:"block",parse:function(a,b,c){a=l(a);b=[];var d=eval(a.name);delete a.name;p[d]={type:"function",subTree:b,defautParams:a,process:function(e,f){var g=n(this.defautParams,f);return k(this.subTree,t("$",t("",{},f),g,e))}};i(c,b)}},javascript:{type:"block",parse:function(a,b,c){b.push({type:"build-in",name:"javascript",code:c})},process:function(a,b){o(a.code,b);return""}},include:{type:"function",parse:function(a,b){b.push({type:"build-in",name:"include",params:l(a)})},
process:function(a,b){var c=n(a.params,b),d=c.file;if(!(d in z)){z[d]=[];var e=jSmart.prototype.getTemplate(d);if(typeof e!="string")throw Error("No template for "+d);i(C(e.replace(/\r\n/g,"\n")),z[d])}d=k(z[d],t("$",t("",{},b),c));if("assign"in a.params){b["$"+c.assign]=d;return""}return d}},"extends":{type:"function",parse:function(a,b){var c=l(a);c=eval(c.file);var d=jSmart.prototype.getTemplate(c);if(typeof d!="string")throw Error("No template for "+c);i(C(d.replace(/\r\n/g,"\n")),b)}},block:{type:"block",
parse:function(a,b,c){a=l(a);b.push({type:"build-in",name:"block",blockName:a.name});v[a.name]=[];i(c,v[a.name])},process:function(a,b){return k(v[a.blockName],b)}},eval:{type:"function",parse:function(a,b){b.push({type:"build-in",name:"eval",params:l(a)})},process:function(a,b){var c=n(a.params,b),d=[];i(c["var"],d);d=k(d,b);if(c=c.__get("assign",false))b["$"+c]=d;else return d;return""}},assign:{type:"function",parse:function(a,b){var c=l(a);b.push({type:"build-in",name:"assign",params:c})},process:function(a,
b){var c="shorthand"in a.params?a.params["var"]:o(a.params["var"],b),d=a.params.value;if(d.match(/^ *".*" *$/)){d=eval(d);if(!B(d,b)){var e=[];i(d,e);d='"'+k(e,b)+'"'}}b["$"+c]=null;o("$"+c+"="+d,b);return""}},append:{type:"function",parse:function(a,b){b.push({type:"build-in",name:"append",params:l(a)})},process:function(a,b){var c=n(a.params,b),d="$"+c["var"];if(!(d in b)||!(b[d]instanceof Array))b[d]=[];var e=c.__get("index",null);if(e)b[d][e]=c.value;else b[d].push(c.value);return""}},strip:{type:"block",
parse:function(a,b,c){i(c.replace(/[ \t]*[\r\n]+[ \t]*/g,""),b)}},literal:{type:"block",parse:function(a,b,c){b.push({type:"text",data:c})}},ldelim:{type:"function",parse:function(a,b){b.push({type:"text",data:"{"})}},rdelim:{type:"function",parse:function(a,b){b.push({type:"text",data:"}"})}}},p={},E={},z={},v=null;jSmart=function(a){this.tree=[];v=this.blocks={};i(C(a.replace(/\r\n/g,"\n")),this.tree)};jSmart.prototype.fetch=function(a){v=this.blocks;return k(this.tree,t("$",{},a,{smarty:{capture:{},
foreach:{},section:{}}}))};jSmart.prototype.registerPlugin=function(a,b,c){if(a=="modifier")E[b]=c;else p[b]={type:a,process:c}};jSmart.prototype.getTemplate=function(a){throw Error("No template for "+a);};jSmart.prototype.auto_literal=true;jSmart.prototype.registerPlugin("function","counter",function(a,b){var c="__counter@"+a.__get("name","default");if(c in b){if("start"in a)b[c].value=parseInt(a.start);else if("down"==b[c].direction)b[c].value-=b[c].skip;else b[c].value+=b[c].skip;b[c].skip=a.__get("skip",
b[c].skip);b[c].direction=a.__get("direction",b[c].direction);b[c].assign=a.__get("assign",b[c].assign)}else b[c]={value:parseInt(a.__get("start",1)),skip:a.__get("skip",1),direction:a.__get("direction","up"),assign:a.__get("assign",null)};if(b[c].assign){b["$"+b[c].assign]=b[c].value;return""}if(a.__get("print",true))return b[c].value;return""});jSmart.prototype.registerPlugin("function","cycle",function(a,b){var c="__cycle@"+a.__get("name","default");if(c in b){if(a.__get("advance","true"))b[c].i+=
1;if(b[c].i>=b[c].arr.length||a.__get("reset",false))b[c].i=0}else{var d=[],e=a.values;if(e instanceof Object)for(nm in e)d.push(e[nm]);else{d=a.__get("delimiter",",");d=e.split(d)}b[c]={arr:d,i:0}}if(a.__get("assign",false)){b["$"+a.assign]=b[c].arr[b[c].i];return""}if(a.__get("print",true))return b[c].arr[b[c].i];return""});jSmart.prototype.registerPlugin("modifier","capitalize",function(a,b){var c=RegExp(b?"[\\W\\d]+":"\\W+"),d=null,e="";for(d=a.match(c);d;d=a.match(c)){var f=a.slice(0,d.index);
e+=f.match(/\d/)?f:f.charAt(0).toUpperCase()+f.slice(1);e+=a.slice(d.index,d.index+d[0].length);a=a.slice(d.index+d[0].length)}if(a.match(/\d/))return e+a;return e+a.charAt(0).toUpperCase()+a.slice(1)});jSmart.prototype.registerPlugin("modifier","cat",function(a,b){b=b?b:"";return a+b});jSmart.prototype.registerPlugin("modifier","count_characters",function(a,b){return b?a.length:a.replace(/\s/g,"").length});jSmart.prototype.registerPlugin("modifier","count_paragraphs",function(a){if(a=a.match(/\n+/g))return a.length+
1;return 1});jSmart.prototype.registerPlugin("modifier","count_sentences",function(a){if(a=a.match(/[^\s]\.(?!\w)/g))return a.length;return 0});jSmart.prototype.registerPlugin("modifier","count_words",function(a){if(a=a.match(/\w+/g))return a.length;return 0});jSmart.prototype.registerPlugin("modifier","defaultValue",function(a,b){if(a)return a;return a?a:b?b:""});jSmart.prototype.registerPlugin("modifier","indent",function(a,b,c){b=b?b:4;c=c?c:" ";for(var d="";b--;)d+=c;b=a.match(/\n+$/);return d+
a.replace(/\n+$/,"").replace(/\n/g,"\n"+d)+(b?b[0]:"")});jSmart.prototype.registerPlugin("modifier","lower",function(a){return a.toLowerCase()});jSmart.prototype.registerPlugin("modifier","nl2br",function(a){return a.replace(/\n/g,"<br />\n")});jSmart.prototype.registerPlugin("modifier","regex_replace",function(a,b,c){b=b.match(/^ *\/(.*)\/(.*) *$/);return(new String(a)).replace(RegExp(b[1],"g"+(b.length>1?b[2]:"")),c)});jSmart.prototype.registerPlugin("modifier","replace",function(a,b,c){a=new String(a);
var d="",e=-1;for(e=a.indexOf(b);e>=0;e=a.indexOf(b)){d+=a.slice(0,e)+c;a=a.slice(e+b.length)}return d+a});jSmart.prototype.registerPlugin("modifier","spacify",function(a,b){b||(b=" ");return a.replace(/(\n|.)(?!$)/g,"$1"+b)});jSmart.prototype.registerPlugin("modifier","strip",function(a,b){b=b?b:" ";return(new String(a)).replace(/[\s]+/g,b)});jSmart.prototype.registerPlugin("modifier","strip_tags",function(a,b){b=b==null?true:b;return(new String(a)).replace(/<[^>]*?>/g,b?" ":"")});jSmart.prototype.registerPlugin("modifier",
"truncate",function(a,b,c,d,e){b=b?b:80;c=c!=null?c:"...";if(a.length<=b)return a;b-=Math.min(b,c.length);if(e)return a.slice(0,Math.floor(b/2))+c+a.slice(a.length-Math.floor(b/2));d||(a=a.slice(0,b+1).replace(/\s+?(\S+)?$/,""));return a.slice(0,b)+c});jSmart.prototype.registerPlugin("modifier","upper",function(a){return a.toUpperCase()});jSmart.prototype.registerPlugin("modifier","wordwrap",function(a,b,c,d){b=b?b:80;c=c?c:"\n";b-=Math.min(b,c.length);a=a.split("\n");var e=0;for(e=0;e<a.length;++e){for(var f=
a[e],g="",h=0;h+b<f.length;){var m=f.slice(h,h+b+1);d||(m=m.replace(/(\s+)\S+$/,"$1"));m=m.slice(0,b);h+=m.length;for(g+=m.replace(/\s+$/,"").replace(/^\s+/,"")+c;f.charAt(h).match(/\s/);)++h}a[e]=g+f.slice(h)}return a.join("\n")});String.prototype.fetch=function(a){return(new jSmart(this)).fetch(a)}})();
